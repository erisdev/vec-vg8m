#include <hwregs.h>
#include <string.h>

typedef void (*int_handler_t)(void);
int_handler_t __at(0x0E20) int_vblank;
int_handler_t __at(0x0E22) int_hblank;

static void VBLANK(void) __interrupt(0x20);
static void HBLANK(void) __interrupt(0x22);

struct sprite {
    char vpos;
    char hpos;
    short pat_name;
};

static short hblank_counter = 0;
short saved_vscroll;
short saved_hscroll;

static const char txt_palette[] = {0, 0x15};
static const char map_palette[] = {0, 2, 0x0F, 0x11};
static const char spr_palette[] = {0, 1, 2, 3, 4, 5, 6, 7};

static const short background[] = {
    '0', '1', '2', '3',
    '4', '5', '6', '7',
    '8', '9', 'A', 'B',
    'C', 'D', 'E', 'F'
};

static const short msgbox[] = {
    0x2001, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2002, 0x2003,
    0x2004, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2014,
    0x2004, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2014,
    0x2004, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2014,
    0x2011, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2012, 0x2013
};

static const char msg[] = "Hello, cruel WORLD!!";

struct sprite sprites[] = {
    {0, 0, 0x4600}
};


void main() {
    int_vblank = VBLANK;
    int_hblank = HBLANK;

    memcpy(r_palettes[0], txt_palette, sizeof(txt_palette));
    memcpy(r_palettes[1], map_palette, sizeof(map_palette));
    memcpy(r_palettes[2], spr_palette, sizeof(spr_palette));

    memcpy(r_palettes[3], (void*)0x38, 8);
    memcpy(r_palettes[4], (void*)0x38, 8);
    memcpy(r_palettes[5], (void*)0x38, 8);
    memcpy(r_palettes[6], (void*)0x38, 8);
    memcpy(r_palettes[7], (void*)0x38, 8);

    r_map_name_addr  = (void*)background;
    r_map_pat_addr   = (void*)0x1000;
    r_map_vsize      = 4;
    r_map_hsize      = 4;
    r_map_vscroll    = 0;
    r_map_hscroll    = 0;

    r_txt_addr       = (void*)msg;
    r_txt_vsize      =   1;
    r_txt_hsize      =  20;
    r_txt_vscroll    = 232;
    r_txt_hscroll    =  16;

    r_spr_def_addr   = (void*)sprites;
    r_spr_pat_addr   = (void*)main;
    r_spr_count      = 1;

    __asm
00001$: halt
        jp 00001$
    __endasm;
}

static void VBLANK() __interrupt(0x20) {
    hblank_counter  = 0;

    r_map_name_addr = (void*)background;
    r_map_pat_addr  = (void*)0x1000;
    r_map_vsize     = 4;
    r_map_hsize     = 4;
    r_map_vscroll   = ++saved_vscroll;
    r_map_hscroll   = ++saved_hscroll;

    sprites[0].hpos += 1;
    sprites[0].vpos = 64 + (sprites[0].hpos & 0x1F);
}

static void HBLANK() __interrupt(0x22) {
    if (++hblank_counter == 216) {
        saved_vscroll   = r_map_vscroll;
        saved_hscroll   = r_map_hscroll;

        r_map_name_addr = (void*)msgbox;
        r_map_pat_addr  =  (void*)0x38;
        r_map_vsize     =  5;
        r_map_hsize     = 48;
        r_map_vscroll   =  0;
        r_map_hscroll   =  0;
    }
}
